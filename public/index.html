<html>

<head>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">    <script src="js/globals.js"></script>
    
    <link rel="stylesheet" href="css/CalendarClass.css">
    <script src="js/CalendarClass.js"></script>
    <link rel="stylesheet" href="css/ModalPopup.css">
    <script src="js/ModalPopup.js"></script>
    <script src="js/TabsClass.js"></script>
    <script src="js/DraggableList.js"></script>
    <script src="js/VertTabsClass.js"></script>
    <script src="js/MessageBox.js"></script>
    <script src="js/AutocompleteClass.js"></script>
    <script src="js/BonCalendar.js"></script>
    <script src="js/BonStrip.js"></script>
    <script src="js/helpers.js"></script>
    <script src="js/ItemsList.js"></script>     
    <script src="js/BonForm.js"></script>
    <script src="js/BonRepository.js"></script>
    <script src="js/BonConfig.js"></script>
    <script src="js/BonWall.js"></script>
    <script src="js/loginHandler.js"></script>

    <style>
        body {
            font-family: sans-serif;
            font-size: 16px;
        }
    
        @media screen and (max-width: 700px) {
            body {
                font-size: 1.5vmax;
            }
        }


        :root {
            --primary-color: #8e631f;
            --secondary-color: #f1e6b2;
            --complimentary-color: #88BFB5;
            --contrast-color: #F2E527;
            --light-color: #D2A9D9;
        }

        .nav-container {
            background: #191919;
            min-height: 100vh;
            font-family: Montserrat, sans-serif;
        }

        nav a {
            font-size: 40px;
            color: var(--secondary-color);
            text-decoration: none;
            padding: 20px;
            text-align: center;
        }

        a.active {
            color: var(--primary-color);
            background: var(--secondary-color);

        }

        nav {
            position: fixed;
            left: 0;
            z-index: 50;
            display: flex;
            justify-content: space-around;
            flex-direction: column;
            height: 100vh;
            background: var(--primary-color);
        }

        section {
            position: absolute;
            top: 0;
            height: 100vh;
            opacity: 0;
            display: none;
            justify-content: center;
            align-items: center;
        }



        /* Styles applied on trigger */
        section:target {
            opacity: 1;
            left: 10%;
            height: 100%;
            width:90%;
            display: flex;
        }


        .menu-content {
            background: var(--secondary-color);
        }

        .form > label
        {
        float: left;
        clear: right;
        }

        .form > input
        {
        float: right;
        }



    </style>
    <script>
        function toggleMenu(elem) {
            document.querySelectorAll(".nav-menu").forEach(e=>{
                e.classList.remove("active");
            })
            elem.classList.add("active")
        }

        function syncMenu() {
            let url=window.location.href;
            let m=url.match(/#.*/);
            if(m) {
                let menuId=m[0];
                let menuElem=document.querySelector(`a[href='${menuId}']`);
                if(menuElem) {
                    toggleMenu(menuElem);
                }
            }
        }

        function logout() {
                Globals.myLoginHandler.logout();
                location.reload();
                return false;
        };

        function updateUser() {
            document.querySelector("#logout").style.display="none";
            document.querySelector("#update-user").style.display="";
            Globals.myLoginHandler.populateUserInfoForm("#update-user");

        }


    </script>

</head>

<body>

    <nav>
        <a href="#login-tab"  class="nav-menu" title="Login" onclick="toggleMenu(this)"><i class="fa fa-key"></i></a>
        <a href="" id="link-to-grocy" class="nav-menu" title="Grocy" target="_blank"><i class="fa fa-database"></i></a>
        <a href="#calendar-tab" data-check-access="" class="nav-menu" title="Kalender" onclick="toggleMenu(this);Globals.myCalender.refresh()"><i class="fa fa-home"></i></a>
        <a href="#kitchen-tab" data-check-access="" class="nav-menu" title="Kökken vy idag" onclick="toggleMenu(this);Globals.myKitchenBonWall.getBonsForToday();"><i class="fa fa-cutlery"></i></a>
        <a href="#future-tab" data-check-access="" class="nav-menu" title="Senare" onclick="toggleMenu(this);Globals.myFutureBonWall.getFutureBons();"><i class="fa fa-sun-o"></i></a>
        <a href="#invoice-tab" data-check-access="${ADMIN} || ${USER} " class="nav-menu" title="Fakturer" onclick="toggleMenu(this);Globals.myInvoiceBonWall.getAllBons();"><i class="fa fa-money"></i></a>
        <a href="#admin-tab" data-check-access="${ADMIN}" class="nav-menu" title="Admin" onclick="toggleMenu(this)"><i class="fa fa-wrench"></i></a>

    </nav>

    <div class='nav-container menu-content'>
        <section id='login-tab'>

                <form id="login" class="login-form-style" autocomplete="off" method="post">
                    <fieldset>
                        <legend>Login</legend>
                        <p id="error-msg" style="color:red"></p>
                        <input type="text" name="username" placeholder="userid/mail" autocomplete="nope"> <br><br>
                        <input type="password" name="password" placeholder="password" autocomplete="nope">
                        <div style="margin-top:10px">
                            <input type="submit" id="login-button" value="Login">
                        </div>
                        <br>
                        <a href="javascript:void(0);" style="font-size: small;" onclick="document.querySelector('#login').style.display='none';document.querySelector('#forgot-password').style.display='block';">Glömt lösenord?</a>
        
                    </fieldset>
                </form>
                <span id="logout" style="display:none"><button onclick="updateUser()">Bruger info</button><button onclick="logout()" style="margin-left:5px">Logout</button></span>
                <form id="forgot-password" class="login-form-style" autocomplete="off" method="post" style="display:none;">
                    <fieldset>
                        <legend>Glömt Lösenord</legend>
                        <p id="error-msg" style="color:red"></p>
                        <input type="text" name="identity" placeholder="userid/mail" autocomplete="nope"> <br><br>
                        <div style="margin-top:10px">
                            <input type="submit" id="send" value="Send">
                        </div>
        
                    </fieldset>
                </form>

                <form id="reset-password" class="login-form-style" autocomplete="off" method="post" style="display:none;">
                    <fieldset>
                        <legend>Återställ Lösenord</legend>
                        <p id="error-msg" style="color:red"></p>
                        <input type="password" name="password" placeholder="password" autocomplete="nope">
                        <div style="margin-top:10px">
                            <input type="submit" id="new-password" value="Uppdatera">
                        </div>
        
                    </fieldset>
                </form>
                
                <form id="update-user" class="login-form-style" autocomplete="off" method="post" style="display:none;">
                    <fieldset class="form">
                        <legend>Uppdater bruger info</legend>
                        <p id="error-msg" style="color:red"></p>
                        <label for="username">Bruger-id:</label><input disabled type="text" name="username" id="username"><br>
                        <label for="name">Navn:</label><input type="text" name="name" id="name"><br>
                        <label for="email">Email:</label><input type="email" name="email" id="email"><br>
                        <label for="phonenr">Telefon:</label><input type="tel" name="phonenr" id="phonenr"><br>
                        <label for="password">Password:</label><input type="password" name="password" id="password"><br>
                        <br><br>
                        <div style="width:100%">
                            <input type="submit" id="update-user" value="Uppdater">
                            <input type="button" id="cancel" value="Avbryd" onclick="document.querySelector('#logout').style.display='';document.querySelector('#update-user').style.display='none';">
                        </div>
        
                    </fieldset>
                </form> 

        </section>

        <section id='calendar-tab'>
            <div id="calendar"></div>
        </section>
        <section id='kitchen-tab'>
            <div id="kitchen"></div>
        </section>
        <section id='future-tab'>
            <div id="future"></div>
        </section>        
        <section id='invoice-tab'>
            <div id="invoice"></div>
        </section>
        <section id='admin-tab'>
            <div id="admin"></div>
        </section>
    </div>

    <script>

        document.querySelector("#link-to-grocy").href=Globals.grocyLink;

        Globals.myCalender=new BonCalendar("#calendar");
        Globals.myConfig=new BonConfig("#admin");
        Globals.myKitchenBonWall=new BonWall("#kitchen","approved",["preparing","done"],["preparing","done","delivered"]);
        Globals.myKitchenBonWall.getBonsForToday();

        Globals.myInvoiceBonWall=new BonWall("#invoice","delivered",["preparing","done"],["invoiced"]);
        Globals.myInvoiceBonWall.getAllBons();

        Globals.myFutureBonWall=new BonWall("#future","new",["needInfo","approved","preparing"],[]);
        Globals.myFutureBonWall.getFutureBons();

        Globals.myLoginHandler = new LoginHandler();
        Globals.myLoginHandler.setLoginForm("#login");
        Globals.myLoginHandler.whenLoggedIn(() => {
           
            Globals.myLoginHandler.getUserInfo((userInfo)=>{
                Globals.userInfo=userInfo;
                Globals.myLoginHandler.checkAccess(Globals.userInfo?.roles);
            });
            
            document.querySelector("#login").style.display="none";
            document.querySelector("#logout").style.display="";

        })
        Globals.myLoginHandler.setForgotPasswordForm("#forgot-password");
        Globals.myLoginHandler.whenForgotPassword(()=>{
            alert("Reset mail sent");
            location.reload();
        });


        Globals.myLoginHandler.setResetPasswordForm("#reset-password");
        Globals.myLoginHandler.whenResetPassword(()=>{
            alert("Password reset");
            window.location.href=Globals.myLoginHandler.removeResetTokenFromUrl();
;
        });


        Globals.myLoginHandler.setUpdateForm("#update-user");
        Globals.myLoginHandler.whenUpdate(()=>{
            Globals.myLoginHandler.getUserInfo((userInfo)=>{
                Globals.userInfo=userInfo;
            });
            document.querySelector("#update-user").querySelector("#cancel").click();

        })


        if(Globals.myLoginHandler.isResetRequest()) {
            document.querySelector("#login").style.display="none";
            document.querySelector("#reset-password").style.display="block";

        }




        if (Globals.myLoginHandler.isLoggedIn()) {
            Globals.myLoginHandler.onLoggedIn();    
        } else {
            window.location.href="#login-tab"
        }
        syncMenu();
        
</script>

</body>

</html>